---
title: "Quality Control Figures"
date: 2023-07-03
author: Samantha Yuen
output:
  html_document:
    toc: yes
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_dir = "./"
    )
  })
editor_options:
  chunk_output_type: inline
---

**Goal**: Optimizing formatting of figures for my thesis

## Load Libraries

```{r}
set.seed(100)

library(ggplot2)
library(SeuratObject)
library(Seurat)

library(dplyr)

library(conflicted)
conflict_prefer("select", "dplyr") ## required in %>% dplyr

print(getwd())
size = 5

samplePaletteGBM <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#CC79A7", "#ff716e")
samplePaletteSC <- c("#999999", "#0072B2", "#194c76", "#D55E00")
  # SF11159, SF11209, SF11215, SF11232, SF11247, SF11285, 
  # SRR10353960, SRR10353961, SRR10353962
```

## Load Data (GSC)

```{r}
load("D:\\backup files\\2021-11-11\\Cluster\\scratch\\gete-gbm\\results\\GBM-GSC neuroblastoma\\2021-06-11\\ge_gbmsc.RData")
load("D:\\backup files\\2021-11-11\\Cluster\\scratch\\gete-gbm\\results\\GBM-GSC neuroblastoma\\2021-06-11\\gte_gbmsc.RData")
print(ls()) #ge_gbmsc #gte_gbmsc

print(head(DefaultAssay(ge_gbmsc)))
print(head(DefaultAssay(gte_gbmsc)))
colnames(ge_gbmsc@meta.data)
colnames(gte_gbmsc@meta.data)

# Factor sample names
ge_gbmsc$sample <- factor(ge_gbmsc$sample, levels = c("SRR10353960", "SRR10353961", "SRR10353962"))
gte_gbmsc$sample <- factor(gte_gbmsc$sample, levels = c("SRR10353960", "SRR10353961", "SRR10353962"))
```

## Quality Control Figures

(pre-filtered Seurat Objects)

```{r}
## MitoRatio x UMI x Genes
p <- ge_gbmsc@meta.data %>% 
    ggplot(aes(x=nUMI, y=nGene, color=mitoRatio)) + 
    geom_point() + 
    scale_colour_gradient(low = "gray90", high = "black") +
    stat_smooth(method=lm) +
    scale_x_log10() + 
    scale_y_log10() + 
    labs(x = "log10 UMI Detected per Cell", y = "log10 Genes Detected per Cell") +
    theme_classic() +
    geom_vline(xintercept = 1000, linetype = "dashed", colour = "red") +
    geom_hline(yintercept = 300, linetype = "dashed", colour = "red") +
    facet_wrap(~sample) + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), axis.title.y = element_text(size=11, hjust=0.8), 
          strip.background = element_blank(),
          panel.border = element_rect(fill = NA, colour = "black"))
p
ggsave("fig_gsc_ge_umigenemitoratio_intercepts.tiff", plot = p, units="in", width=size*1.2, height=size*0.5, dpi=300, compression = 'lzw')

p <- gte_gbmsc@meta.data %>% 
    ggplot(aes(x=nUMI, y=nGene, color=mitoRatio)) + 
    geom_point() + 
    scale_colour_gradient(low = "gray90", high = "black") +
    stat_smooth(method=lm) +
    scale_x_log10() + 
    scale_y_log10() + 
    labs(x = "log10 UMI Detected per Cell", y = "log10 Genes Detected per Cell") +
    theme_classic() +
    geom_vline(xintercept = 1000, linetype = "dashed", colour = "red") +
    geom_hline(yintercept = 300, linetype = "dashed", colour = "red") +
    facet_wrap(~sample) + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), axis.title.y = element_text(size=11, hjust=0.8), 
          strip.background = element_blank(),
          panel.border = element_rect(fill = NA, colour = "black"))
# p
ggsave("fig_gsc_gte_umigenemitoratio_intercepts.tiff", plot = p, units="in", width=size*1.2, height=size*0.5, dpi=300, compression = 'lzw')

## MitoRatio
p <- ge_gbmsc@meta.data %>% 
  	ggplot(aes(color=sample, x=mitoRatio, fill=sample)) + 
  	geom_density(alpha = 0.2) + 
    scale_color_manual(values = samplePaletteSC) +
    scale_fill_manual(values = samplePaletteSC) +
  	theme_classic() +
  	geom_vline(xintercept = 0.2, linetype = "dashed", colour = "red")
p
ggsave("fig_gsc_ge_mitoratio_density.tiff", plot = p, units="in", width=size*0.9, height=size*0.5, dpi=300, compression = 'lzw')

p <- gte_gbmsc@meta.data %>% 
  	ggplot(aes(color=sample, x=mitoRatio, fill=sample)) + 
  	geom_density(alpha = 0.2) + 
    scale_color_manual(values = samplePaletteSC) +
    scale_fill_manual(values = samplePaletteSC) +
  	theme_classic() +
  	geom_vline(xintercept = 0.2, linetype = "dashed", colour = "red")
p
ggsave("fig_gsc_gte_mitoratio_density.tiff", plot = p, units="in", width=size*0.9, height=size*0.5, dpi=300, compression = 'lzw')

## Genes x UMI (Density plot)
p <- ge_gbmsc@meta.data %>% 
  	ggplot(aes(color=sample, x=log10GenesPerUMI, fill=sample)) + 
  	geom_density(alpha = 0.2) + 
    scale_color_manual(values = samplePaletteSC) +
    scale_fill_manual(values = samplePaletteSC) +
  	theme_classic() +
  	geom_vline(xintercept = 0.8, linetype = "dashed", colour = "red")
p
ggsave("fig_gsc_ge_log10GenesUMI_density.tiff", plot = p, units="in", width=size*0.9, height=size*0.5, dpi=300, compression = 'lzw')

p <- gte_gbmsc@meta.data %>% 
  	ggplot(aes(color=sample, x=log10GenesPerUMI, fill=sample)) + 
  	geom_density(alpha = 0.2) + 
    scale_color_manual(values = samplePaletteSC) +
    scale_fill_manual(values = samplePaletteSC) +
  	theme_classic() +
  	geom_vline(xintercept = 0.8, linetype = "dashed", colour = "red")
p
ggsave("fig_gsc_gte_log10GenesUMI_density.tiff", plot = p, units="in", width=size*0.9, height=size*0.5, dpi=300, compression = 'lzw')

```

## Remove objects from memory

```{r}
rm(ge_gbmsc, gte_gbmsc)
gc()
```

## Load Data (GBM)

Location of unfiltered datasets: "D:\backup files\\2021-11-11\Cluster\scratch\gete-gbm\results\GBM Bhaduri (archive)\\2021-03-30_seuratQC\combined\_GE_select_seurat-03-30.RData" "D:\backup files\\2021-11-11\Cluster\scratch\gete-gbm\results\GBM Bhaduri (archive)\\2021-03-30_seuratQC\gte\_brain_seurat-03-30.RData"

Location of Filtered Datasets: filt_GE_select.intergrated = "D:\backup files\\2021-12-20\Cluster\scratch\gete-gbm\data\\2021-04-01_integrate\filt\_GE_select.intergrated.RData" filt_gte_brain.intergrated = "D:\backup files\\2021-12-20\Cluster\scratch\gete-gbm\data\\2021-04-01_integrate\filt\_gte_brain.intergrated.RData"

```{r}
load("D:\\backup files\\2021-11-11\\Cluster\\scratch\\gete-gbm\\results\\GBM Bhaduri (archive)\\2021-03-30_seuratQC\\combined_GE_select_seurat-03-30.RData")
print(ls()) #combined_GE_select
ge_meta <- combined_GE_select@meta.data
rm(combined_GE_select)

load("D:\\backup files\\2021-11-11\\Cluster\\scratch\\gete-gbm\\results\\GBM Bhaduri (archive)\\2021-03-30_seuratQC\\gte_brain_seurat-03-30.RData")
print(ls())
gte_meta <- gte_brain@meta.data
rm(gte_brain)
colnames(ge_meta)
colnames(gte_meta)
```

## Quality Control Figures (GBM)

(pre-filtered Seurat Objects)

```{r}
# Factor sample names
ge_meta$sample <- unlist(ge_meta$sample)
gte_meta$sample <- unlist(gte_meta$sample)

#View unique rows
ge_meta %>% distinct(sample, seq_folder, .keep_all=FALSE)
gte_meta %>% distinct(sample, seq_folder, .keep_all=FALSE)

sampleNames <- c("SF11159", "SF11209", "SF11209", "SF11247", "SF11215", "SF11232", "SF11247", "SF11215", "SF11159", "SF11285", "SF11232", "SF11285")

ge_meta$sampleName <- ""
gte_meta$sampleName <- ""

for(i in 1:length(sampleNames)) {
    ge_meta$sampleName[which(ge_meta$seq_folder == i)] <- sampleNames[i]
    gte_meta$sampleName[which(gte_meta$seq_folder == i)] <- sampleNames[i]
}

ge_meta$sampleName <- factor(ge_meta$sampleName, levels = sort(unique(ge_meta$sampleName)))
gte_meta$sampleName <- factor(gte_meta$sampleName, levels = sort(unique(gte_meta$sampleName)))

## MitoRatio x UMI x Genes
p <- ge_meta%>% 
    ggplot(aes(x=nUMI, y=nGene, color=mitoRatio)) + 
    geom_point() + 
    scale_colour_gradient(low = "gray90", high = "black") +
    stat_smooth(method=lm) +
    scale_x_log10() +
    scale_y_log10() +
    labs(x = "log10 UMI Detected per Cell", y = "log10 Genes Detected per Cell") +
    theme_classic() +
    geom_vline(xintercept = 1000, linetype = "dashed", colour = "red") +
    geom_hline(yintercept = 300, linetype = "dashed", colour = "red") +
    facet_wrap(~sampleName) + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
          strip.background = element_blank(),
          panel.border = element_rect(fill = NA, colour = "black"))
p
ggsave("fig_gbm_ge_umigenemitoratio_intercepts.tiff", plot = p, units="in", width=size*1.2, height=size*0.8, dpi=300, compression = 'lzw')

p <- gte_meta %>% 
    ggplot(aes(x=nUMI, y=nGene, color=mitoRatio)) + 
    geom_point() + 
    scale_colour_gradient(low = "gray90", high = "black") +
    stat_smooth(method=lm) +
    scale_x_log10() + 
    scale_y_log10() + 
    labs(x = "log10 UMI Detected per Cell", y = "log10 Genes Detected per Cell") +
    theme_classic() +
    geom_vline(xintercept = 1000, linetype = "dashed", colour = "red") +
    geom_hline(yintercept = 300, linetype = "dashed", colour = "red") +
    facet_wrap(~sampleName) + 
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1),
          strip.background = element_blank(),
          panel.border = element_rect(fill = NA, colour = "black"))
p
ggsave("fig_gbm_gte_umigenemitoratio_intercepts.tiff", plot = p, units="in", width=size*1.2, height=size*0.8, dpi=300, compression = 'lzw')

## MitoRatio
p <- ge_meta %>% 
  	ggplot(aes(color=sampleName, x=mitoRatio, fill=sampleName)) + 
  	geom_density(alpha = 0.2) + 
    scale_color_manual(values = samplePaletteGBM) +
    scale_fill_manual(values = samplePaletteGBM) +
  	theme_classic() +
  	geom_vline(xintercept = 0.2, linetype = "dashed", colour = "red")
p
ggsave("fig_gbm_ge_mitoratio_density.tiff", plot = p, units="in", width=size*0.9, height=size*0.5, dpi=300, compression = 'lzw')

p <- gte_meta %>% 
  	ggplot(aes(color=sampleName, x=mitoRatio, fill=sampleName)) + 
  	geom_density(alpha = 0.2) + 
    scale_color_manual(values = samplePaletteGBM) +
    scale_fill_manual(values = samplePaletteGBM) +
  	theme_classic() +
  	geom_vline(xintercept = 0.2, linetype = "dashed", colour = "red")
p
ggsave("fig_gbm_gte_mitoratio_density.tiff", plot = p, units="in", width=size*0.9, height=size*0.5, dpi=300, compression = 'lzw')


## Genes x UMI (Density plot)
p <- ge_meta %>% 
  	ggplot(aes(color=sampleName, x=log10GenesPerUMI, fill=sampleName)) + 
  	geom_density(alpha = 0.2) + 
    scale_color_manual(values = samplePaletteGBM) +
    scale_fill_manual(values = samplePaletteGBM) +
  	theme_classic() +
  	geom_vline(xintercept = 0.8, linetype = "dashed", colour = "red")
p
ggsave("fig_gbm_ge_log10GenesUMI_density.tiff", plot = p, units="in", width=size*0.9, height=size*0.5, dpi=300, compression = 'lzw')

p <- gte_meta %>% 
  	ggplot(aes(color=sampleName, x=log10GenesPerUMI, fill=sampleName)) + 
  	geom_density(alpha = 0.2) + 
    scale_color_manual(values = samplePaletteGBM) +
    scale_fill_manual(values = samplePaletteGBM) +
  	theme_classic() +
  	geom_vline(xintercept = 0.8, linetype = "dashed", colour = "red")
p
ggsave("fig_gbm_gte_log10GenesUMI_density.tiff", plot = p, units="in", width=size*0.9, height=size*0.5, dpi=300, compression = 'lzw')

```

## End of Notebook

```{r}
sessionInfo()
```
